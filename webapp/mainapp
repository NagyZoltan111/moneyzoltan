<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Goal Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // Use environment variables provided by the Canvas environment
          
    const firebaseConfig = {
        apiKey: "AIzaSyBQKq1YggF3GjajZAmjHYtGmZk0ihPJwRs",
        authDomain: "moneyzoltan-68329.firebaseapp.com",
        projectId: "moneyzoltan-68329",
        storageBucket: "moneyzoltan-68329.firebasestorage.app",
        messagingSenderId: "969689374570",
        appId: "1:969689374570:web:373adfc3bfd72b5df94f13",
        measurementId: "G-8QT0J3C8C1"
        };


        // --- App State ---
        let db, auth, userId, goalsCollection;

        // --- DOM Elements ---
        const goalsContainer = document.getElementById('goalsContainer');
        const newGoalForm = document.getElementById('newGoalForm');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const appContent = document.getElementById('appContent');
        const errorToast = document.getElementById('errorToast');
        const errorMessage = document.getElementById('errorMessage');

        // --- Utility Functions ---
        
        /**
         * Formats a number as USD currency.
         * @param {number} amount - The number to format.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        /**
         * Shows an error message toast.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorToast.classList.remove('translate-y-full', 'opacity-0');
            errorToast.classList.add('translate-y-0', 'opacity-100');
            
            // Hide after 3 seconds
            setTimeout(() => {
                errorToast.classList.remove('translate-y-0', 'opacity-100');
                errorToast.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        }

        // --- Firebase Functions ---

        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // User is signed in, set up Firestore collection and listener
                        const collectionPath = `artifacts/${appId}/users/${userId}/savingsGoals`;
                        goalsCollection = collection(db, collectionPath);
                        setupGoalsListener();
                    } else {
                        // User is signed out
                        userId = null;
                        loadingSpinner.classList.add('hidden');
                        showError("Authentication failed. Please refresh.");
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingSpinner.classList.add('hidden');
                showError("Could not connect to database. " + error.message);
            }
        }

        /**
         * Sets up the real-time listener for savings goals.
         */
        function setupGoalsListener() {
            if (!goalsCollection) return;

            onSnapshot(query(goalsCollection), (snapshot) => {
                const goals = [];
                snapshot.forEach((doc) => {
                    goals.push({ id: doc.id, ...doc.data() });
                });
                renderGoals(goals);
                loadingSpinner.classList.add('hidden');
                appContent.classList.remove('hidden');
            }, (error) => {
                console.error("Error listening to goals:", error);
                showError("Failed to load goals. " + error.message);
                loadingSpinner.classList.add('hidden');
            });
        }

        /**
         * Adds a new goal to Firestore.
         * @param {Event} e - The form submit event.
         */
        async function handleAddGoal(e) {
            e.preventDefault();
            const goalNameInput = e.target.goalName;
            const targetAmountInput = e.target.targetAmount;
            const currentAmountInput = e.target.currentAmount;

            const goalName = goalNameInput.value.trim();
            const targetAmount = parseFloat(targetAmountInput.value);
            const currentAmount = parseFloat(currentAmountInput.value) || 0;

            // --- Validation ---
            if (!goalName) {
                showError("Please enter a name for your goal.");
                return;
            }
            if (isNaN(targetAmount) || targetAmount <= 0) {
                showError("Please enter a valid target amount greater than $0.");
                return;
            }
            if (isNaN(currentAmount) || currentAmount < 0) {
                showError("Please enter a valid current amount (or $0).");
                return;
            }
            if (currentAmount > targetAmount) {
                showError("Current amount cannot be greater than the target amount.");
                return;
            }

            try {
                // Add the document to Firestore
                await addDoc(goalsCollection, {
                    goalName,
                    targetAmount,
                    currentAmount,
                });

                // Clear the form
                goalNameInput.value = '';
                targetAmountInput.value = '';
                currentAmountInput.value = '';

            } catch (error) {
                console.error("Error adding goal:", error);
                showError("Failed to add goal. " + error.message);
            }
        }

        /**
         * Updates the current amount for a specific goal.
         * @param {string} id - The document ID of the goal.
         * @param {number} currentAmount - The goal's current saved amount.
         * @param {number} targetAmount - The goal's target amount.
         */
        async function handleUpdateGoal(id, currentAmount, targetAmount) {
            const updateInput = document.getElementById(`update-${id}`);
            if (!updateInput) return;

            const amountToUpdate = parseFloat(updateInput.value);

            if (isNaN(amountToUpdate) || amountToUpdate === 0) {
                showError("Please enter a valid amount to add or subtract.");
                return;
            }

            const newCurrentAmount = currentAmount + amountToUpdate;

            if (newCurrentAmount < 0) {
                showError("Your saved amount cannot go below $0.");
                return;
            }
            
            if (newCurrentAmount > targetAmount) {
                showError("You've reached your goal! Amount cannot exceed target.");
                // We'll set it to the target amount instead of erroring
                try {
                    const goalRef = doc(db, `artifacts/${appId}/users/${userId}/savingsGoals`, id);
                    await updateDoc(goalRef, { currentAmount: targetAmount });
                    updateInput.value = ''; // Clear input
                } catch (error) {
                    console.error("Error updating goal:", error);
                    showError("Failed to update goal. " + error.message);
                }
                return;
            }

            try {
                const goalRef = doc(db, `artifacts/${appId}/users/${userId}/savingsGoals`, id);
                await updateDoc(goalRef, { currentAmount: newCurrentAmount });
                updateInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error updating goal:", error);
                showError("Failed to update goal. " + error.message);
            }
        }

        /**
         * Deletes a goal from Firestore.
         * @param {string} id - The document ID of the goal.
         */
        async function handleDeleteGoal(id) {
            // No custom confirm, just delete.
            // In a real app, you'd use a custom modal here.
            try {
                const goalRef = doc(db, `artifacts/${appId}/users/${userId}/savingsGoals`, id);
                await deleteDoc(goalRef);
            } catch (error) {
                console.error("Error deleting goal:", error);
                showError("Failed to delete goal. " + error.message);
            }
        }

        /**
         * Renders the list of goals in the DOM.
         * @param {Array} goals - An array of goal objects from Firestore.
         */
        function renderGoals(goals) {
            goalsContainer.innerHTML = ''; // Clear existing goals

            if (goals.length === 0) {
                goalsContainer.innerHTML = `
                    <div class="text-center text-gray-500 p-8 bg-white rounded-lg shadow">
                        You have no savings goals yet. Add one above to get started!
                    </div>
                `;
                return;
            }

            // Sort goals: newest first (optional, but nice)
            // We can't use orderBy in Firestore without an index, so we sort in JS.
            // Let's sort by name for consistency.
            goals.sort((a, b) => a.goalName.localeCompare(b.goalName));

            goals.forEach(goal => {
                const { id, goalName, targetAmount, currentAmount } = goal;
                const progress = targetAmount > 0 ? (currentAmount / targetAmount) * 100 : 0;
                const isComplete = currentAmount >= targetAmount;

                const goalElement = document.createElement('div');
                goalElement.className = "bg-white p-5 rounded-lg shadow-md transition-all duration-300";
                goalElement.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-gray-800">${goalName}</h3>
                        <button data-delete-id="${id}" class="text-gray-400 hover:text-red-500 transition-colors" title="Delete Goal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <!-- Progress Text -->
                    <div class="mb-2">
                        <span class="text-lg font-medium ${isComplete ? 'text-green-600' : 'text-blue-600'}">${formatCurrency(currentAmount)}</span>
                        <span class="text-sm text-gray-500"> / ${formatCurrency(targetAmount)}</span>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden">
                        <div class="h-4 rounded-full ${isComplete ? 'bg-green-500' : 'bg-blue-500'} transition-all duration-500" style="width: ${progress}%"></div>
                    </div>
                    
                    ${isComplete ? `
                        <div class="text-center font-semibold text-green-600 bg-green-50 p-3 rounded-md">
                            Goal Reached! Congratulations!
                        </div>
                    ` : `
                        <!-- Update Form -->
                        <div class="flex space-x-2">
                            <input type="number" id="update-${id}" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Amount (e.g., 50 or -20)">
                            <button data-update-id="${id}" data-current="${currentAmount}" data-target="${targetAmount}" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                Update
                            </button>
                        </div>
                    `}
                `;

                goalsContainer.appendChild(goalElement);
            });

            // --- Add Event Listeners ---
            // We use event delegation on the container for efficiency
            goalsContainer.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('button[data-delete-id]');
                if (deleteButton) {
                    handleDeleteGoal(deleteButton.dataset.deleteId);
                }

                const updateButton = e.target.closest('button[data-update-id]');
                if (updateButton) {
                    handleUpdateGoal(
                        updateButton.dataset.updateId,
                        parseFloat(updateButton.dataset.current),
                        parseFloat(updateButton.dataset.target)
                    );
                }
            });
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            newGoalForm.addEventListener('submit', handleAddGoal);
        });

    </script>

    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
  

    <div class="container mx-auto max-w-lg p-4">
        
        <!-- Header -->
        <header class="my-6">
            <h1 class="text-3xl font-bold text-center text-blue-700">
                Savings Goal Tracker
            </h1>
        </header>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="flex justify-center items-center py-10">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3 text-gray-600">Loading your goals...</span>
        </div>

        <!-- Main App Content (Hidden until loaded) -->
        <main id="appContent" class="hidden">
            <!-- Add New Goal Form -->
            <section class="mb-6">
                <form id="newGoalForm" class="bg-white p-5 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Add a New Goal</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="goalName" class="block text-sm font-medium text-gray-700">Goal Name</label>
                            <input type="text" id="goalName" name="goalName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., New Laptop" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="targetAmount" class="block text-sm font-medium text-gray-700">Target Amount ($)</label>
                                <input type="number" id="targetAmount" name="targetAmount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 1500" min="0.01" step="0.01" required>
                            </div>
                            <div>
                                <label for="currentAmount" class="block text-sm font-medium text-gray-700">Current Amount ($)</label>
                                <input type="number" id="currentAmount" name="currentAmount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 300 (or 0)" min="0" step="0.01">
                            </div>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Add Goal
                        </button>
                    </div>
                </form>
            </section>

            <!-- Goals List -->
            <section>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Goals</h2>
                <div id="goalsContainer" class="space-y-4">
                    <!-- Goals will be dynamically inserted here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Error Toast Notification -->
    <div id="errorToast" class="fixed bottom-4 right-4 w-full max-w-xs bg-red-600 text-white p-4 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform translate-y-full opacity-0">
        <p id="errorMessage" class="font-medium">An error occurred.</p>
    </div>

</body>
</html>
